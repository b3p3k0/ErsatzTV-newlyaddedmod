@page "/media/movies"
@page "/media/movies/page/{PageNumber:int}"
@inherits MultiSelectBase<MovieList>
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@using ErsatzTV.Application.MediaCards
@using ErsatzTV.Application.MediaCollections
@using ErsatzTV.Application.Search
@using ErsatzTV.Extensions
@using ErsatzTV.Enums
@using Microsoft.AspNetCore.WebUtilities
@implements IDisposable

<MudForm Style="max-height: 100%">
    <MudPaper Square="true" Style="display: flex; height: 64px; min-height: 64px; width: 100%; z-index: 100;">
        <MediaCardPager Query="@_query"
                        PageNumber="@PageNumber"
                        PageSize="@PageSize"
                        TotalCount="@_data.Count"
                        NextPage="@NextPage"
                        PrevPage="@PrevPage"
                        AddSelectionToCollection="@AddSelectionToCollection"
                        AddSelectionToPlaylist="@AddSelectionToPlaylist"
                        ClearSelection="@ClearSelection"
                        IsSelectMode="@IsSelectMode"
                        SelectionLabel="@SelectionLabel"
                        SortMode="@_sortMode"
                        SortModeChanged="@OnSortModeChanged"/>
    </MudPaper>
    <div class="d-flex flex-column" style="height: 100vh; overflow-x: auto">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pt-8">
            <MudStack Row="true" Wrap="Wrap.Wrap">
                @if (_sortMode == MediaSortMode.Title)
                {
                    <FragmentLetterAnchor TCard="MovieCardViewModel" Cards="@_data.Cards">
                        <MediaCard Data="@context"
                                   Href="@($"media/movies/{context.MovieId}")"
                                   AddToCollectionClicked="@AddToCollection"
                                   SelectClicked="@(e => SelectClicked(context, e))"
                                   IsSelected="@IsSelected(context)"
                                   IsSelectMode="@IsSelectMode()"/>
                    </FragmentLetterAnchor>
                }
                else
                {
                    @foreach (MovieCardViewModel card in GetSortedCards())
                    {
                        <MediaCard Data="@card"
                                   Href="@($"media/movies/{card.MovieId}")"
                                   AddToCollectionClicked="@AddToCollection"
                                   SelectClicked="@(e => SelectClicked(card, e))"
                                   IsSelected="@IsSelected(card)"
                                   IsSelectMode="@IsSelectMode()"/>
                    }
                }
            </MudStack>
        </MudContainer>
    </div>
</MudForm>

@if (_data.PageMap is not null && _sortMode == MediaSortMode.Title)
{
    <LetterBar PageMap="@_data.PageMap"
               BaseUri="media/movies"
               Query="@_query"/>
}

@code {
    private static int PageSize => 100;

    [Parameter]
    public int PageNumber { get; set; }

    private MovieCardResultsViewModel _data = new(0, new List<MovieCardViewModel>(), null);
    private string _query;
    private PersistingComponentStateSubscription _persistingSubscription;
    private MediaSortMode _sortMode = MediaSortMode.Title;

    protected override Task OnInitializedAsync()
    {
        _persistingSubscription = ApplicationState.RegisterOnPersisting(PersistData);
        _query = NavigationManager.Uri.GetSearchQuery();
        _sortMode = GetSortModeFromUrl();

        return base.OnInitializedAsync();
    }

    private MediaSortMode GetSortModeFromUrl()
    {
        var uri = new Uri(NavigationManager.Uri);
        var parsed = QueryHelpers.ParseQuery(uri.Query);
        if (parsed.TryGetValue("sort", out var value) && value == "dateadded")
        {
            return MediaSortMode.DateAdded;
        }
        return MediaSortMode.Title;
    }

    private IEnumerable<MovieCardViewModel> GetSortedCards()
    {
        return _sortMode switch
        {
            MediaSortMode.DateAdded => _data.Cards.OrderByDescending(m => m.DateAdded),
            _ => _data.Cards.OrderBy(m => m.SortTitle)
        };
    }

    private void OnSortModeChanged(MediaSortMode newSortMode)
    {
        _sortMode = newSortMode;
        NavigationManager.NavigateTo(BuildNavigationUri($"media/movies/page/{PageNumber}"));
    }

    private string BuildNavigationUri(string basePath)
    {
        var queryParams = new List<string>();

        if (!string.IsNullOrWhiteSpace(_query))
        {
            (string key, string value) = _query.EncodeQuery();
            queryParams.Add($"{key}={value}");
        }

        if (_sortMode == MediaSortMode.DateAdded)
        {
            queryParams.Add("sort=dateadded");
        }

        return queryParams.Any() ? $"{basePath}?{string.Join("&", queryParams)}" : basePath;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (PageNumber == 0)
        {
            PageNumber = 1;
        }

        if (!ApplicationState.TryTakeFromJson("_data", out MovieCardResultsViewModel restored))
        {
            _data = await RefreshData(CancellationToken);
        }
        else
        {
            _data = restored;
        }
    }

    private Task PersistData()
    {
        ApplicationState.PersistAsJson("_data", _data);

        return Task.CompletedTask;
    }

    void IDisposable.Dispose()
    {
        _persistingSubscription.Dispose();
        base.Dispose();
    }

    protected override async Task<MovieCardResultsViewModel> RefreshData(CancellationToken cancellationToken)
    {
        string searchQuery = string.IsNullOrWhiteSpace(_query) ? "type:movie" : $"type:movie AND ({_query})";
        return await Mediator.Send(new QuerySearchIndexMovies(searchQuery, PageNumber, PageSize), cancellationToken);
    }

    private void PrevPage()
    {
        NavigationManager.NavigateTo(BuildNavigationUri($"media/movies/page/{PageNumber - 1}"));
    }

    private void NextPage()
    {
        NavigationManager.NavigateTo(BuildNavigationUri($"media/movies/page/{PageNumber + 1}"));
    }

    private void SelectClicked(MediaCardViewModel card, MouseEventArgs e)
    {
        List<MediaCardViewModel> GetSortedItems()
        {
            return GetSortedCards().ToList<MediaCardViewModel>();
        }

        SelectClicked(GetSortedItems, card, e);
    }

    private async Task AddToCollection(MediaCardViewModel card)
    {
        if (card is MovieCardViewModel movie)
        {
            var parameters = new DialogParameters { { "EntityType", "movie" }, { "EntityName", movie.Title } };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

            IDialogReference dialog = await Dialog.ShowAsync<AddToCollectionDialog>("Add To Collection", parameters, options);
            DialogResult result = await dialog.Result;
            if (result is { Canceled: false, Data: MediaCollectionViewModel collection })
            {
                var request = new AddMovieToCollection(collection.Id, movie.MovieId);
                Either<BaseError, Unit> addResult = await Mediator.Send(request, CancellationToken);
                addResult.Match(
                    Left: error =>
                    {
                        Snackbar.Add($"Unexpected error adding movie to collection: {error.Value}");
                        Logger.LogError("Unexpected error adding movie to collection: {Error}", error.Value);
                    },
                    Right: _ => Snackbar.Add($"Added {movie.Title} to collection {collection.Name}", Severity.Success));
            }
        }
    }

}
